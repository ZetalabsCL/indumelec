<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">

<th:block layout:fragment="welcome">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="javascript: void(0);">Home</a></li>
                        <li class="breadcrumb-item"><a href="javascript: void(0);">Cotizaci&oacute;n</a></li>
                        <li class="breadcrumb-item active">Revisi&oacute;n Cotizaci&oacute;n</li>
                    </ol>
                </div>
                <h4 class="page-title">Formulario de Revisi&oacute;n Cotizaci&oacute;n</h4>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="content">
    <form method="post">
        <input id="quoteId" name="quoteId" type="hidden" th:value="${quoteId}"/>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="header-title">Informacion General </h4>
                        <br>
                        <div class="row">
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="quoteCode">Codigo Cotizacion:</label>
                                    <input id="quoteCode" name="quoteCode" type="text" class="form-control" readonly="readonly">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="workOrder">Codigo OT:</label>
                                    <input id="workOrder" name="workOrder" type="text" class="form-control" readonly="readonly">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="deliveryDate">Fecha de Entrega:</label>
                                    <input id="deliveryDate" name="deliveryDate" type="text" class="form-control" readonly="readonly">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="priorityType">Prioridad:</label>
                                    <select id="priorityType" name="priorityType" class="form-control">
                                        <option th:each="item : ${ T(com.zetalabs.indumelec.model.types.PriorityType).values() }" th:value="${item}" th:text="${item.description}"/>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="name">Cliente:</label>
                                    <input id="name" name="name" type="text" class="form-control" readonly="readonly">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="contact">Contacto:</label>
                                    <input id="contact" name="contact" type="text" class="form-control" readonly="readonly">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="phone">Tel&eacute;fono:</label>
                                    <input id="phone" name="phone" type="text" class="form-control" readonly="readonly">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="header-title">Productos y Servicios</h4>
                        <p class="text-muted font-14">
                            Listado de productos o servicios solicitados por el cliente
                        </p>

                        <div class="row">
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="quantity">Cantidad:</label>
                                    <input id="quantity" name="quantity" type="text" class="form-control decimal-0-places" placeholder="Ingrese Cantidad">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="description">Descripci&oacute;n:</label>
                                    <textarea class="form-control" id="description" name="description" placeholder="Ingrese Descripci&oacute;n" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="measure">Medidas:</label>
                                    <input id="measure" name="measure" type="text" class="form-control" placeholder="Ingrese Medidas">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="price">Precio:</label>
                                    <input id="price" name="price" type="text" class="form-control decimal-0-places text-right" placeholder="Ingrese Precio">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="notes">Notas:</label>
                                    <textarea class="form-control" id="notes" name="notes" placeholder="Ingrese Notas" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <h4><button id="updateRow" name="updateRow" class="btn btn-success" style="position: relative;top:-9px;" type="button">Actualizar Detalle</button></h4>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="table-responsive">
                                    <table id="cotizaciones-table" class="table mt-4" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th width="5%">Cantidad</th>
                                                <th width="23%">Descripci&oacute;n</th>
                                                <th width="11%">Medidas</th>
                                                <th width="12%">Precio Unitario</th>
                                                <th width="12%">Precio Total</th>
                                                <th width="22%">Notas</th>
                                                <th width="15%">&nbsp;</th>
                                            </tr>
                                        </thead>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-1">
                                <div class="form-group">
                                    <a href="#" id="approve" name="approve" class="btn btn-success" data-toggle="modal" data-target="#approveQuoteDialog">Aprobar</a>
                                </div>
                            </div>
                            <div class="col-1">
                                <div class="form-group">
                                    <a href="#" id="reject" name="reject" class="btn btn-danger" data-toggle="modal" data-target="#rejectQuoteDialog">Rechazar</a>
                                </div>
                            </div>
                            <div class="col-1">
                                <div class="form-group">
                                    <a href="#" id="update" name="update" class="btn btn-info" data-toggle="modal" data-target="#storedQuoteDialog">Actualizar</a>
                                </div>
                            </div>
                            <div class="col-1">
                                <div class="form-group">
                                    <a th:href="@{/admin/dashboard}" id="back" name="back" class="btn btn-info">Volver</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div id="storedQuoteDialog" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="primary-header-modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header modal-colored-header bg-primary">
                    <h4 class="modal-title" id="primary-header-modalLabel">Cotizaci&oacute;n Actualizada</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                </div>
                <div class="modal-body">
                    <h5 class="mt-0 text-dark">Su Cotizaci&oacute;n ha sido actualizada correctamente</h5>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-dismiss="modal">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="approveQuoteDialog" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="primary-header-modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header modal-colored-header bg-primary">
                    <h4 class="modal-title" id="primary-header-modalLabel2">Confirmar Cotizaci&oacute;n</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                </div>
                <div class="modal-body">
                    <h5 class="mt-0 text-dark">&iquest;Esta seguro que desea aprobar la cotizacion?</h5>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" id="approveQuote">Aprobar Cotizaci&oacute;n</button>
                    <button type="button" class="btn btn-light" data-dismiss="modal">Volver</button>
                </div>
            </div>
        </div>
    </div>

    <div id="rejectQuoteDialog" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="primary-header-modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header modal-colored-header bg-primary">
                    <h4 class="modal-title">Rechazar Cotizaci&oacute;n</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                </div>
                <div class="modal-body">
                    <h5 class="mt-0 text-dark">&iquest;Esta seguro que desea rechazar la cotizacion?</h5>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal"  id="rejectQuote">Rechazar Cotizaci&oacute;n</button>
                    <button type="button" class="btn btn-light" data-dismiss="modal">Volver</button>
                </div>
            </div>
        </div>
    </div>

    <div id="workOrderNumberDialog" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="multiple-twoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title text-dark" id="multiple-twoModalLabel">Ingrese N&uacute;mero OT</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="workOrder">N&uacute;mero OT:</label>
                        <input type="text" class="form-control" id="workOrderCode" name="workOrderCode" placeholder="Ingrese el # de OT">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="generateWorkOrder">Genera OT</button>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        $(document).ready(function() {
            var selectedRow;
            var t = $('#cotizaciones-table').DataTable( {
                responsive: true,
                searching: false,
                pageLength: 5,
                lengthMenu: [ 1, 5, 10, "Todos" ],
                createdRow: function ( row, data, index ) {
                    $('td', row).eq(2).addClass('text-center');
                    $('td', row).eq(3).addClass('text-right');
                    $('td', row).eq(4).addClass('text-right');

                    $('td', row).eq(0).addClass('align-middle');
                    $('td', row).eq(1).addClass('align-middle');
                    $('td', row).eq(2).addClass('align-middle');
                    $('td', row).eq(3).addClass('align-middle');
                    $('td', row).eq(4).addClass('align-middle');
                    $('td', row).eq(5).addClass('align-middle');
                }, "language": {
                    "lengthMenu": "Mostrando _MENU_ registros por p&aacute;gina",
                    buttons: {
                        copy: 'Copiar'
                    },
                    "zeroRecords": "Sin resultados - lo siento!",
                    "info": "Mostrando p&aacute;gina _PAGE_ de _PAGES_",
                    "infoEmpty": "No hay registros disponibles",
                    "search": "Buscar",
                    "infoFiltered": "(filtrados de _MAX_ registros totales)",
                    "paginate": {
                        "previous": "Anterior",
                        "next": "Siguiente"
                    }
                }
            });

            $.ajax({
                url: '/api/quote/info',
                type: "post",
                data: { quoteId: /*[[${quoteId}]]*/ 'default' },
                dataType: "json",
                success: function (data) {
                    $("#quoteCode").val(data.quoteCode);
                    $("#workOrder").val(data.workOrder);
                    $("#deliveryDate").val(data.deliveryDate);
                    $("#name").val(data.company);
                    $("#contact").val(data.contact);
                    $("#phone").val(data.phone);
                    $("#priorityType").val(data.priorityType);

                    var count=0;
                    data.details.forEach(function(detail){
                        var quantity = parseFloat(detail.quantity);
                        var price = parseFloat(detail.price);
                        var total = isNaN(quantity * price) ? 0 : (quantity * price);

                        t.row.add([
                            quantity.toLocaleString('es-CL'),
                            detail.description,
                            detail.measure,
                            '$ ' + price.toLocaleString('es-CL'),
                            '$ ' + total.toLocaleString('es-CL'),
                            detail.notes,
                            '<button id="editRow" name="editRow" class="btn btn-info editRow" type="button"><i class="mdi mdi-tooltip-edit"></i> Editar</button>&nbsp;' +
                            '<button id="removeRow" name="removeRow" class="btn btn-danger removeRow" type="button"><i class="mdi mdi-delete"></i> Eliminar</button>'
                        ]).node().id = 'row-'+count;
                        count++;
                        t.draw(false);
                    });
                },
                error: function () {

                }
            });

            $("#updateRow").on("click", function() {
                if (validDetail()) {
                    var quantity = parseFloat($("#quantity").val());
                    var price = parseFloat($("#price").val());
                    var total = isNaN(quantity * price) ? 0 : (quantity * price);

                    t.row(selectedRow).data([
                        quantity.toLocaleString('es-CL'),
                        $("#description").val().replace(/(?:\r\n|\r|\n)/g, '<br>'),
                        $("#measure").val(),
                        '$ ' + price.toLocaleString('es-CL'),
                        '$ ' + total.toLocaleString('es-CL'),
                        $("#notes").val(),
                        '<button id="editRow" name="editRow" class="btn btn-info editRow" type="button"><i class="mdi mdi-tooltip-edit"></i> Editar</button>&nbsp;' +
                        '<button id="removeRow" name="removeRow" class="btn btn-danger removeRow" type="button"><i class="mdi mdi-delete"></i> Eliminar</button>'
                    ]).draw();

                    $("#quantity").val('');
                    $("#description").val('');
                    $("#measure").val('');
                    $("#price").val('');
                    $("#notes").val('');
                }
            });

            $("#cotizaciones-table tbody").on('click', '.removeRow', function(){
                t.row($(this).parents('tr')).remove().draw();
            });

            $('#cotizaciones-table tbody').on( 'click', '.editRow', function () {
                selectedRow = $(this).parents('tr');
                var detail = t.row($(this).parents('tr')).data();
                var strNumber = detail[3].replace('$','').replace(/\./g, '');

                $("#quantity").val(detail[0]);
                $("#description").val(detail[1]);
                $("#measure").val(detail[2]);
                $("#price").val(parseFloat(strNumber));
                $("#notes").val(detail[5]);
            });

            $("#update").on("click", function() {
                if (validForm(t)) {
                    var dataArray = [];

                    t.rows().every(function (rowIdx, tableLoop, rowLoop) {
                        dataArray.push(this.data());
                    });

                    $.ajax({
                        type: 'post',
                        url: '/api/quote/save',
                        data: {
                            frmInfo: JSON.stringify($('form').serializeArray()),
                            userId: /*[[${session.username}]]*/ 'default',
                            details: JSON.stringify(dataArray)
                        },
                        dataType: 'json',
                        success: function () {
                            $('#storedQuoteDialog').modal('show');
                        }
                    });
                }
            });

            $("#approveQuote").on("click", function() {
                var workOrderId = $("#workOrder").val();

                if (validForm(t) && !isEmpty(workOrderId)) {
                    var dataArray = [];

                    t.rows().every(function (rowIdx, tableLoop, rowLoop) {
                        dataArray.push(this.data());
                    });

                    $.ajax({
                        type: 'post',
                        url: '/api/quote/approve',
                        data: {
                            frmInfo: JSON.stringify($('form').serializeArray()),
                            userId: /*[[${session.username}]]*/ 'default',
                            details: JSON.stringify(dataArray)
                        },
                        dataType: 'json',
                        success: function () {
                            location.href = /*[[@{/admin/dashboard}]]*/ 'default';
                        }
                    });
                } else if (isEmpty(workOrderId)){
                    $('#workOrderNumberDialog').modal('show');
                }
            });

            $("#rejectQuote").on('click', function(){
                if (validForm(t)) {
                    var dataArray = [];

                    t.rows().every(function (rowIdx, tableLoop, rowLoop) {
                        dataArray.push(this.data());
                    });

                    $.ajax({
                        type: 'post',
                        url: '/api/quote/reject',
                        data: {
                            frmInfo: JSON.stringify($('form').serializeArray()),
                            userId: /*[[${session.username}]]*/ 'default',
                            details: JSON.stringify(dataArray)
                        },
                        dataType: 'json',
                        success: function () {
                            location.href = /*[[@{/admin/dashboard}]]*/ 'default';
                        }
                    });
                }
            });

            $(".decimal-0-places").numeric({ decimal: ",", decimalPlaces: 0, negative: false });

            $("#generateWorkOrder").on('click', function(){
                if ($("#workOrderCode").val() != '') {
                    var workOrder = $("#workOrderCode").val();
                    var dataArray = [];

                    t.rows().every(function (rowIdx, tableLoop, rowLoop) {
                        dataArray.push(this.data());
                    });

                    $.ajax({
                        url: '/api/quote/verifyOt',
                        type: "post",
                        data: {
                            workOrderId: workOrder
                        },
                        dataType: "json",
                        success: function (data) {
                            if (data == '0') {
                                $("#workOrder").val($("#workOrderCode").val());

                                $.ajax({
                                    url: '/api/quote/approve',
                                    type: "post",
                                    data: {
                                        frmInfo: JSON.stringify($('form').serializeArray()),
                                        userId: /*[[${session.username}]]*/ 'default',
                                        details: JSON.stringify(dataArray)
                                    },
                                    dataType: "json",
                                    success: function (data) {
                                        location.href = /*[[@{/admin/dashboard}]]*/ 'default';
                                    },
                                    error: function () {
                                        console.log('error on approve');
                                    }
                                });

                                $('#workOrderNumberDialog').modal('hide');
                            } else {
                                alert('# OT ya existe');
                            }
                        },
                        error: function () {
                            console.log('error on verify');
                        }
                    });
                } else {
                    alert('Ingrese # OT');
                }
            });
        } );

        function validDetail(){
            if ($("#quantity").val()==''){
                alert('Ingrese Cantidad');
                return false;
            }

            if ($("#description").val()==''){
                alert('Ingrese Descripcion');
                return false;
            }

            if ($("#measure").val()==''){
                alert('Ingrese Medidas');
                return false;
            }

            if ($("#price").val()==''){
                alert('Ingrese Precio');
                return false;
            }

            return true;
        }

        function validForm(tbl){
            if (tbl.rows().data().count()==0){
                alert('Cotizacion debe tener un producto al menos');
                return false;
            }

            return true;
        }

        function isEmpty(str) {
            return (!str || 0 === str.length);
        }
    </script>
</th:block>
</html>